<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Task 005.02 – Resize-Safe Swapchain/Pipeline Recreation</title>
  <link rel="stylesheet" href="shared.css">
</head>
<body>
<main>
  <header>
    <h1>Task 005.02 – Resize & Out-of-Date Handling</h1>
    <p class="lead">Rebuild swapchain-dependent resources safely on resize or out-of-date events.</p>
  </header>
  <section>
    <h2>When to recreate</h2>
    <ul>
      <li>Framebuffer resize callback sets a flag.</li>
      <li><code>AcquireNextImage</code> returns <code>OUT_OF_DATE</code> or <code>SUBOPTIMAL</code>.</li>
    </ul>
  </section>
  <section>
    <h2>Recreation steps</h2>
    <ol>
      <li><strong>DeviceWaitIdle</strong>.</li>
      <li>Destroy/Free: command buffers, framebuffers, render pass, pipelines, descriptor pool/sets, depth resources, swapchain views, swapchain.</li>
      <li>Create swapchain, views, depth.</li>
      <li>Create render pass, pipelines, framebuffers.</li>
      <li>Create uniform buffers, descriptor pool/sets.</li>
      <li>Allocate command buffers.</li>
      <li>Reset images-in-flight array; clear resize flag.</li>
    </ol>
<pre><code class="language-go">vulkan.DeviceWaitIdle(a.device)
a.cleanupSwapchain()
if err := a.createSwapchain(); err != nil { return err }
if err := a.createImageViews(); err != nil { return err }
if err := a.createDepthResources(); err != nil { return err }
if err := a.createRenderPass(); err != nil { return err }
if err := a.createGraphicsPipeline(); err != nil { return err }
if err := a.createOverlayPipeline(); err != nil { return err }
if err := a.createFramebuffers(); err != nil { return err }
if err := a.createUniformBuffers(); err != nil { return err }
if err := a.createDescriptorPool(); err != nil { return err }
if err := a.createDescriptorSets(); err != nil { return err }
if err := a.allocateCommandBuffers(); err != nil { return err }
a.imagesInFlight = make([]vulkan.Fence, len(a.swapchainImages))
a.framebufferResized = false</code></pre>
  </section>
  <section>
    <h2>Practical notes</h2>
    <p><strong>Avoid zero-sized swapchains.</strong> If the framebuffer is 0×0 (window minimized), block in <code>glfw.WaitEvents()</code> until a positive size is reported, then recreate. Building a swapchain with extent 0 fails on many drivers.</p>
<pre><code class="language-go">for {
  w, h := a.window.GetFramebufferSize()
  if w > 0 && h > 0 { break }
  glfw.WaitEvents()
}</code></pre>
    <p><strong>Keep cleanup symmetrical.</strong> Anything created after the previous <code>DeviceWaitIdle</code> should be destroyed in <code>cleanupSwapchain</code>. That includes descriptor pools, pipelines (both cube and overlay), and command buffers.</p>
    <p><strong>Images-in-flight reset.</strong> After recreation, the old fences refer to destroyed swapchain images. Recreate the tracking slice to avoid waiting on stale fences.</p>
  </section>
  <div class="nav"><a href="index.html">← Back to Hub</a> <a href="step-006-milestone-packaging.html">Next →</a></div>
</main>
</body>
</html>
