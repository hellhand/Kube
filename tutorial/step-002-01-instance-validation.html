<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Task 002.01 – Instance with Validation & Debug Messenger</title>
  <link rel="stylesheet" href="shared.css">
</head>
<body>
<main>
  <header>
    <h1>Task 002.01 – Instance with Validation & Debug Messenger</h1>
    <p class="lead">Create a Vulkan instance that requests validation (if available) and logs validation output.</p>
  </header>
  <section>
    <h2>0) Helper: C-string with pinned Go string</h2>
<pre><code class="language-go">type cString struct {
  str  string
  cptr *C.char
}
func makeCString(s string) cString {
  c := C.CString(s)
  var goStr string
  h := (*reflect.StringHeader)(unsafe.Pointer(&goStr))
  h.Data = uintptr(unsafe.Pointer(c))
  h.Len = len(s)
  return cString{str: goStr, cptr: c}
}</code></pre>
  </section>
  <section>
    <div class="badge">Steps with code</div>
    <ol>
      <li>Get required extensions from GLFW: <code>exts := glfw.GetRequiredInstanceExtensions()</code>.</li>
      <li>Prepare layers: <code>validationLayers := []string{"VK_LAYER_KHRONOS_validation"}</code>; if unavailable, set to empty.</li>
      <li>Create instance (C-allocated strings to avoid Go-pointer issues):
<pre><code class="language-go">appName := makeCString("Kube Vulkan")
engineName := makeCString("No Engine")
defer C.free(unsafe.Pointer(appName.cptr))
defer C.free(unsafe.Pointer(engineName.cptr))

createInfo := vulkan.InstanceCreateInfo{
  SType: vulkan.StructureTypeInstanceCreateInfo,
  PApplicationInfo: &vulkan.ApplicationInfo{
    SType:              vulkan.StructureTypeApplicationInfo,
    PApplicationName:   appName.str,
    ApplicationVersion: vulkan.MakeVersion(1,0,0),
    PEngineName:        engineName.str,
    EngineVersion:      vulkan.MakeVersion(1,0,0),
    ApiVersion:         vulkan.ApiVersion10,
  },
  EnabledExtensionCount:   uint32(len(exts)),
  PpEnabledExtensionNames: exts,
  EnabledLayerCount:       uint32(len(validationLayers)),
  PpEnabledLayerNames:     validationLayers,
}
if res := vulkan.CreateInstance(&createInfo, nil, &a.instance); res != vulkan.Success {
  return fmt.Errorf("create instance: %w", vulkan.Error(res))
}</code></pre>
      </li>
      <li>Install debug messenger if validation is on, pointing to a callback that logs severity/message.</li>
      <li>Call <code>vulkan.InitInstance(a.instance)</code> to load instance-level function pointers.</li>
    </ol>
  </section>
  <section>
    <h2>Deeper explanation</h2>
    <p><strong>Why the custom <code>cString</code>?</strong> Passing Go-managed strings directly to C can trigger <em>Go pointer to Go pointer</em> panics. The helper allocates a C string, then mirrors it as a Go string header so Vulkan sees a stable address.</p>
<pre><code class="language-go">// Debug messenger setup (safe even without layers)
if len(validationLayers) > 0 {
  dbgCreate := vulkan.DebugUtilsMessengerCreateInfoEXT{
    SType: vulkan.StructureTypeDebugUtilsMessengerCreateInfoEXT,
    MessageSeverity: vulkan.DebugUtilsMessageSeverityWarningBitEXT |
                     vulkan.DebugUtilsMessageSeverityErrorBitEXT |
                     vulkan.DebugUtilsMessageSeverityVerboseBitEXT,
    MessageType: vulkan.DebugUtilsMessageTypeGeneralBitEXT |
                 vulkan.DebugUtilsMessageTypeValidationBitEXT |
                 vulkan.DebugUtilsMessageTypePerformanceBitEXT,
    PfnUserCallback: debugCallback, // defined in vk_app.go, logs to stdlib log
  }
  if res := vulkan.CreateDebugUtilsMessengerEXT(a.instance, &dbgCreate, nil, &a.debugMessenger); res != vulkan.Success {
    log.Printf("debug messenger install skipped: %v", res)
  }
}</code></pre>
    <p><strong>Order of operations:</strong> create the instance <em>first</em>, then call <code>vulkan.InitInstance</code>, then install the debug messenger. This guarantees that the extension entry points are loaded before being used.</p>
    <p>If validation layers are missing, the code gracefully skips them and continues with a warning. That behavior mirrors the runtime logs you’ll see in the CLI output.</p>
  </section>
  <div class="nav"><a href="index.html">← Back to Hub</a> <a href="step-002-02-surface-device.html">Next →</a></div>
</main>
</body>
</html>
